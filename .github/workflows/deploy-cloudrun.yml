name: Deploy to Cloud Run

on:
    workflow_dispatch:
        inputs:
            app-name:
                description: "Name of the application to deploy"
                required: true
                type: choice
                options:
                    - frontend
                    - restaurant-catalog-api
            version:
                description: "Version of the application"
                required: true
                type: string
            environment:
                description: "Target environment name"
                required: false
                type: choice
                options:
                    - prod
                    - dev
                    - staging
                default: "prod"
            region:
                description: "Google Cloud Run region"
                required: false
                type: string
                default: "us-central1"
            cloudrun-flags:
                description: "Additional flags for gcloud deploy command"
                required: false
                type: string
                default: ""
    workflow_call:
        inputs:
            app-name:
                description: "Name of the application to deploy"
                required: true
                type: string
            version:
                description: "Version of the application"
                required: true
                type: string
            environment:
                description: "Target environment name"
                required: false
                type: string
                default: "production"
            region:
                description: "Google Cloud Run region"
                required: false
                type: string
                default: "us-central1"
            cloudrun-flags:
                description: "Additional flags for gcloud deploy command"
                required: false
                type: string
                default: ""
        outputs:
            url:
                description: "Deployment URL"
                value: ${{ jobs.deploy.outputs.url }}

jobs:
    deploy:
        runs-on: ubuntu-latest
        outputs:
            url: ${{ steps.deploy.outputs.url }}
        environment:
            name: ${{ inputs.app-name }}.${{ inputs.environment }}
            url: ${{ steps.deploy.outputs.url }}
        steps:
            - uses: actions/checkout@v4

            - name: Authenticate to Google Cloud
              uses: google-github-actions/auth@v2
              with:
                  token_format: access_token
                  workload_identity_provider: projects/764108434612/locations/global/workloadIdentityPools/github-pool/providers/github
                  service_account: meadsoft-dev-sa@smart-quasar-297403.iam.gserviceaccount.com

            - name: Log in to GitHub Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Deploy to Cloud Run
              id: deploy
              uses: google-github-actions/deploy-cloudrun@v2
              with:
                  service: ${{ inputs.app-name }}
                  image: ghcr.io/${{ github.repository_owner }}/${{ inputs.app-name }}:${{ inputs.version }}
                  region: ${{ inputs.region }}
                  flags: ${{ inputs.cloudrun-flags }}

            - name: Create deployment summary
              run: |
                  echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**App:** ${{ inputs.app-name }}" >> $GITHUB_STEP_SUMMARY
                  echo "**Version:** ${{ inputs.version }}" >> $GITHUB_STEP_SUMMARY
                  echo "**Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
                  echo "**Region:** ${{ inputs.region }}" >> $GITHUB_STEP_SUMMARY
                  echo "**Docker Image:** ghcr.io/${{ github.repository_owner }}/${{ inputs.app-name }}:${{ inputs.version }}" >> $GITHUB_STEP_SUMMARY
                  echo "**URL:** ${{ steps.deploy.outputs.url }}" >> $GITHUB_STEP_SUMMARY
