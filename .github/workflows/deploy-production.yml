name: Production Deployment

on:
    push:
        tags:
            - "*/release/v*"
    workflow_dispatch:
        inputs:
            ref:
                description: "Git tag or branch to deploy (e.g., frontend/release/v1.2.3)"
                required: true
                type: string
            cloudrun-flags:
                description: "Additional flags for gcloud deploy command"
                required: false
                type: string
                default: ""
            region:
                description: "Google Cloud Run region"
                required: false
                type: string
                default: "us-central1"

permissions:
    actions: read
    contents: read
    deployments: write
    packages: write

jobs:
    detect-app:
        uses: ./.github/workflows/detect-app.yml
        with:
            ref: ${{ inputs.ref || github.ref_name }}

    build-and-push-image:
        needs: detect-app
        uses: ./.github/workflows/build-and-push-docker-image.yml
        with:
            app-name: ${{ needs.detect-app.outputs.app-name }}
            version: ${{ needs.detect-app.outputs.version }}
            environment: production

    deploy:
        needs: [detect-app, build-and-push-image]
        uses: ./.github/workflows/deploy-cloudrun.yml
        with:
            app-name: ${{ needs.detect-app.outputs.app-name }}
            version: ${{ needs.detect-app.outputs.version }}
            environment: prod
            region: ${{ inputs.region || 'us-central1' }}
            cloudrun-flags: ${{ inputs.cloudrun-flags || '' }}

    create-release:
        runs-on: ubuntu-latest
        needs: [detect-app, build-and-push-image]
        steps:
            - name: Create GitHub Release
              uses: actions/create-release@v1
              with:
                  tag_name: ${{ github.ref_name }}
                  release_name: ${{ needs.detect-app.outputs.app-name }} ${{ needs.detect-app.outputs.version }}
                  body: |
                      Production deployment of **${{ needs.detect-app.outputs.app-name }}** version **${{ needs.detect-app.outputs.version }}**

                      Commit: ${{ github.sha }}
                  draft: false
                  prerelease: false
