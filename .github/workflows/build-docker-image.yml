name: Build Docker Image

on:
    workflow_dispatch:
        inputs:
            app-name:
                description: 'Name of the application to build'
                required: true
                type: choice
                options:
                    - frontend
                    - restaurant-catalog-api
            load:
                description: 'Load image to Docker daemon (for local testing)'
                required: false
                type: boolean
                default: false
    workflow_call:
        inputs:
            app-name:
                description: 'Name of the application to build'
                required: true
                type: string
            load:
                description: 'Load image to Docker daemon (for local testing)'
                required: false
                type: boolean
                default: false

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Validate Dockerfile exists
              id: validate-dockerfile
              run: |
                  DOCKERFILE="./apps/${{ inputs.app-name }}/Dockerfile"
                  if [ ! -f "$DOCKERFILE" ]; then
                    echo "::warning::Dockerfile not found at $DOCKERFILE"
                    echo "::warning::Please create a Dockerfile for ${{ inputs.app-name }} at apps/${{ inputs.app-name }}/Dockerfile"
                    echo "exists=false" >> $GITHUB_OUTPUT
                    exit 1
                  fi
                  echo "exists=true" >> $GITHUB_OUTPUT
                  echo "âœ… Dockerfile found at $DOCKERFILE"

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Build Docker image
              uses: docker/build-push-action@v5
              with:
                  context: .
                  file: ./apps/${{ inputs.app-name }}/Dockerfile
                  push: false
                  load: ${{ inputs.load }}
                  tags: |
                      ${{ inputs.app-name }}:test
                      ${{ inputs.app-name }}:${{ github.sha }}
                  build-args: |
                      NODE_ENV=development
                      APP_NAME=${{ inputs.app-name }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

            - name: Build summary
              run: |
                  echo "## ðŸ‹ Docker Build Summary" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**App:** ${{ inputs.app-name }}" >> $GITHUB_STEP_SUMMARY
                  echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
                  echo "**Tags:** ${{ inputs.app-name }}:test, ${{ inputs.app-name }}:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "Build completed successfully! âœ…" >> $GITHUB_STEP_SUMMARY
